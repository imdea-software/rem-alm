{% extends 'base.html' %}
{% load static %}
{% block contentplaceholder %}

<style>
#select-dropdown > li > span{
  color: black !important
}
.btn{
  background-color: #8c9eff !important;
  /* background: linear-gradient(145deg, #5c6bc0, #cacaca); */
  box-shadow:  20px 20px 60px #bebebe,
             -20px -20px 60px #ffffff;
}
.fault-analysis > table {
  border: 1px solid !important;
}
#man > li{
  color: black !important;
}
.apexcharts-canvas{
  margin-right:10% !important;
}
</style>

<div class="container">
  <div class="row">
    <div class="col"></div>
  </div>
  <div class="row">
       <p class="col s6"> <span>   Elige un equipo para poder visualizar los puertos  <i class="material-icons teal-text darken-1">chat_bubble_outline</i> </span></p>  
  </div>
  <div class="section row">
  <div class="col s6">
        <form action="" id="portForm" name="portForm" method="POST">
          {% csrf_token %}
          <div class="row">
            <input type="hidden" name="vista" id="vista" value='{{vista}}'>
            <div class="input-field col s6 white-text">

              <select id="address" name="address" class="black-text">
                <option selected class="black-text">Elige un equipo</option>
                {% for d in devices %}
                    {% if d == '172.20.237.90' %}
                      <option value="{{d}}">CIEMAT-AL-AD-04 (172.20.237.90)</option>
                    {% endif %}
                    {% if d == '172.20.237.86' %}
                      <option value="{{d}}">CSIC-AL-AD-03 (172.20.237.86)</option>
                    {% endif %}
                   {% endfor %} 
              </select>
              <label for="address">Equipo:</label>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s6 white-text">
              <select id="port" name="port">
                  <option selected>Seleccionar el puerto</option> 
              </select>
              <label for="port">Puerto: </label>
              </div>
            </div>
            <div class="row">
              <div class="input-field col s6 white-text">
                <select class=""  id="type" name="type">
                    <option value="af" selected>Automático</option>
                    <option value="fa">Manual</option>
                  {% if fa %}
                    <option value="man" id="man"><span>Fault Analysis manual</span></option>
                  {% endif %} 
                </select>
                <label for="petition">Tipo: </label>
                </div>
              </div>
              <div class="col s6">
                  <button type="submit" class="btn waves-effect" id="applybutton">Aceptar</button>
                </div>
      </form>
    </div>

    <div class="col s6">
      <p class=""><span class="left-align" name="portname" id="portname"> </span> </p>
      <div class="row">
            <div class="col" name="fault-analysis" id="fault-analysis"></div>
            <div class="col" id="finger-print" name="finger-print"></div>
    </div>
  </div>
  </div>
  <div class="divider" style="display:none !important;"></div>
  <div class="section">
  <div class="teal-text lighten-2" id="message"></div>
</div>
</div>


<div class="chart-section row" style="margin-top: 20px;">
  
  <div id="chart" name="chart" class="col s12 m4 l8 valign-wrapper"  ></div>  
  <!-- <div class="col s12 m4 l2"></div> -->
        </div>


<div class="container">

  <div class="section row">
    <div class="col s6" id="fp-events" name="fp-events"></div>
    <div class="col s6" id="fa-events" name="fa-events" ></div>

</div>

</div>



{% endblock %}

{% block jsbottom %}
<script src="{% static 'script.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>


 $("#portForm").on('submit', function(event){
      document.getElementById('applybutton').disabled=true; 
      /* document.getElementById('applybutton').innerHTML='Recibiendo información...'; */
      var url = "{% url 'ajax-alm' %}";
      var form = document.querySelector("[name='portForm']")
      var port = form.elements.port.value;
      var address = form.elements.address.value;
      var type = form.elements.type.value;
      var csrftoken = getCookie('csrftoken');
      $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
        }
          });
  var info = {
        "port": port,
        "address":address,
        "type" : type
      };
  document.getElementById('message').innerHTML="Se está procesado la información, la gráfica puede tardar unos minutos en ser representada.";
  $.ajax({
      url : url,
      data : info,
      method : "POST",
      dataType:"json",
      success: function(response){ 
        document.getElementById('message').innerHTML=" ";
        document.getElementById('fault-analysis').innerHTML='';
        document.getElementById('finger-print').innerHTML='';
        document.getElementById('fp-events').innerHTML='';
        document.getElementById('fa-events').innerHTML='';
        document.getElementById('chart').innerHTML='';
        document.getElementById('portname').innerHTML='';
        document.getElementById('applybutton').disabled=false;
      if(response['message']){
        document.getElementById('chart').innerHTML=response['message'];
      }else{
        if(response['keys'] && response['value1'] && response['value2']){
          var keys = response['keys'];
          var value1 = response['value1'];
          var value2 = response['value2'];
          var faultanalysis = response['faultanalysis'];
          var fingerprint = response['fingerprint'];
          var fa_events = response['fa_event'];
          var fp_events = response['fp_event'];
          var portname = response['portname'];
          var options = {
                chart: {
                  height: 550,
                  width: 1200,
                  type: "line",
                  stacked: false
                },
                colors: ["#424242","#8c9eff"],
                series: [
                  {
                    name: "Finger Print",
                    data: value1
                  },
                  {
                    name: "Fault analysis",
                    data: value2
                  }
                ],
                events: {
                  mounted: (chart) => {
                    chart.windowResizeHandler();
                  }
                },
                plotOptions: {
                  bar: {
                    columnWidth: "20%"
                  }
                },
                responsive: [
                    {
                      breakpoint: 700,
                      options: {
                        plotOptions: {
                          line: {
                            height:565,
                            width:760,
                          }
                        },
                        legend: {
                          position: "bottom"
                        }
                      }
                    }
                  ],
                xaxis: {
                  categories: keys,
                  type: 'numeric',
                  title:{
                    text:'KM',
                    position: "bottom",
                    style:{
                      color: "#424242",
                    }
                  },
                },
                yaxis: [
                  {
                    axisTicks: {
                      show: true
                    },
                    axisBorder: {
                      show: true,
                      color: ""
                    },
                    labels: {
                      style: {
                        colors: ""
                      }
                    },
                    title: {
                      text: "Finger Print",
                      style: {
                        color: "#424242",
                      }
                    }
                  },
                  {
                    opposite: true,
                    axisTicks: {
                      show: true
                    },
                    axisBorder: {
                      show: true,
                      color: "#8c9eff"
                    },
                    labels: {
                      style: {
                        colors: "#8c9eff"
                      }
                    },
                    title: {
                      text: "Fault analysis",
                      style: {
                        color: "#8c9eff"
                      }
                    }
                  }
                ],
                legend: {
                  horizontalAlign: "left",
                  offsetX: 40
                }
            };
            
            var chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
            document.getElementById('applybutton').innerHTML='Aceptar';
            document.getElementById('applybutton').disabled=false;
            var name = faultanalysis[23] 
            var tfa = faultanalysis[4]
            if (response['value1'] == null | !response['value1'] == null){
              document.getElementById('fault-analysis').innerHTML='No hay información disponible...';
              document.getElementById('chart').innerHTML='';

            }else {
              /* document.getElementById('portname').innerHTML=portname+"  "; */
              createFaultAnalysisTable(faultanalysis);
              createFingerprintTable(fingerprint);
              createEventsFPTable(fp_events);
              createEventsFATable(fa_events);
            }
            
          }else{
            if (response['value1'] == null | !response['value1'] == null){
            document.getElementById('fault-analysis').innerHTML='No hay información disponible...';
            document.getElementById('finger-print').innerHTML='';
            document.getElementById('chart').innerHTML='';
            $('#applybutton').removeAttr('disabled');
          }  
          }
        }
      },
        error: function(response){
          document.getElementById('fault-analysis').innerHTML='';
          document.getElementById('finger-print').innerHTML='';
          document.getElementById('fp-events').innerHTML='';
          document.getElementById('fa-events').innerHTML='';
          document.getElementById('chart').innerHTML='';
          document.getElementById('portname').innerHTML='';
          document.getElementById('chart').innerHTML="Ahora mismo no hay información disponible sobre esta gráfica...";
          document.getElementById('applybutton').disabled=false;
            }
          });
        event.preventDefault();
});


</script>

{% endblock %}

